name: Test

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Setup configuration
        run: |
          cat > src/main/resources/application.properties << EOF
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_VALIDITY=${{ secrets.JWT_VALIDITY }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          REDIS_TIMEOUT=${{ secrets.REDIS_TIMEOUT }}
          DISCORD_ALARM_WEBHOOK_URL=${{ secrets.DISCORD_ALARM_WEBHOOK_URL }}
          DISCORD_ERROR_WEBHOOK_URL=${{ secrets.DISCORD_ERROR_WEBHOOK_URL }}
          UPLOAD_DIR=${{ secrets.UPLOAD_DIR }}
          BASE_URL=${{ secrets.BASE_URL }}
          FIREBASE_WEB_API_KEY=${{ secrets.FIREBASE_WEB_API_KEY }}
          EOF

          cat > src/main/resources/firebase-key.json << EOF
          ${{ secrets.FIREBASE_KEY }}
          EOF

      - name: Run tests
        run: ./gradlew test jacocoTestReport

      - name: Parse coverage report
        if: github.event_name == 'pull_request'
        id: coverage
        run: |
          python3 << 'PYEOF'
          import xml.etree.ElementTree as ET, glob, os

          # JaCoCo
          tree = ET.parse('build/reports/jacoco/test/jacocoTestReport.xml')
          counters = {}
          for c in tree.getroot().findall('counter'):
              t = c.get('type')
              missed, covered = int(c.get('missed')), int(c.get('covered'))
              total = missed + covered
              pct = f"{covered / total * 100:.1f}" if total > 0 else "0.0"
              counters[t] = (covered, total, pct)

          def bar(pct_str):
              filled = round(float(pct_str) / 5)
              return 'â–ˆ' * filled + 'â–‘' * (20 - filled)

          line, branch, method = counters['LINE'], counters['BRANCH'], counters['METHOD']

          # Test results
          tests = skipped = failed = 0
          for f in glob.glob('build/test-results/test/TEST-*.xml'):
              suite = ET.parse(f).getroot()
              tests += int(suite.get('tests', 0))
              skipped += int(suite.get('skipped', 0))
              failed += int(suite.get('failures', 0)) + int(suite.get('errors', 0))
          passed = tests - skipped - failed

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"line_bar={bar(line[2])}\n")
              f.write(f"line_pct={line[2]}\n")
              f.write(f"line_detail={line[0]}/{line[1]}\n")
              f.write(f"branch_bar={bar(branch[2])}\n")
              f.write(f"branch_pct={branch[2]}\n")
              f.write(f"branch_detail={branch[0]}/{branch[1]}\n")
              f.write(f"method_bar={bar(method[2])}\n")
              f.write(f"method_pct={method[2]}\n")
              f.write(f"method_detail={method[0]}/{method[1]}\n")
              f.write(f"passed={passed}\n")
              f.write(f"skipped={skipped}\n")
              f.write(f"failed={failed}\n")
          PYEOF

      - name: Post coverage comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              '## ðŸ“Š Test Coverage',
              '',
              '```',
              `Line     ${{ steps.coverage.outputs.line_bar }}  ${{ steps.coverage.outputs.line_pct }}% (${{ steps.coverage.outputs.line_detail }})`,
              `Branch   ${{ steps.coverage.outputs.branch_bar }}  ${{ steps.coverage.outputs.branch_pct }}% (${{ steps.coverage.outputs.branch_detail }})`,
              `Method   ${{ steps.coverage.outputs.method_bar }}  ${{ steps.coverage.outputs.method_pct }}% (${{ steps.coverage.outputs.method_detail }})`,
              '```',
              '',
              `âœ… ${{ steps.coverage.outputs.passed }} passed Â· â­ï¸ ${{ steps.coverage.outputs.skipped }} skipped Â· âŒ ${{ steps.coverage.outputs.failed }} failed`,
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '## ðŸ“Š Test Coverage';
            const existing = comments.find(c => c.body.startsWith(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: '**/build/test-results/test/TEST-*.xml'
          comment_title: 'Test Results'
          check_name: 'Test Results'
          report_individual_runs: true
          
      - name: Report test failures
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/build/test-results/test/TEST-*.xml'
          token: ${{ github.token }}