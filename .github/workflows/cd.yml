name: CD - Deploy

on:
  pull_request:
    branches: [main]
    types: [closed]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and push latest image
        run: |
          # PRì—ì„œ ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ latestë¡œ íƒœê·¸
          PR_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${{ github.event.number }}"
          LATEST_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          
          echo "ðŸ”„ PR ì´ë¯¸ì§€ë¥¼ latestë¡œ íƒœê·¸ ë³€ê²½ ì¤‘..."
          docker pull $PR_IMAGE
          docker tag $PR_IMAGE $LATEST_IMAGE
          docker push $LATEST_IMAGE
          echo "âœ… ì´ë¯¸ì§€ íƒœê·¸ ì™„ë£Œ: $LATEST_IMAGE"

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            echo "ðŸš€ ë°°í¬ ì‹œìž‘..."
            cd /home/vagom/duit-server || mkdir -p /home/vagom/duit-server && cd /home/vagom/duit-server

            # Compose ëª…ë ¹ì–´ í™•ì¸
            if docker compose version >/dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
            else
              COMPOSE_CMD="docker-compose"
            fi
            echo "ì‚¬ìš©í•  Compose ëª…ë ¹ì–´: $COMPOSE_CMD"
  
            # í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p docker
  
            # docker-compose.yml ë‹¤ìš´ë¡œë“œ
            echo "ðŸ“‹ docker-compose.yml ì—…ë°ì´íŠ¸ ì¤‘..."
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o docker/docker-compose.yml \
                 "https://api.github.com/repos/${{ github.repository }}/contents/docker/docker-compose.yml"
  
            # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            echo "ðŸ”§ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¤‘..."
            : > docker/.env
            echo "IMAGE_REGISTRY=${{ env.REGISTRY }}" >> docker/.env
            echo "IMAGE_NAME=${{ env.IMAGE_NAME }}" >> docker/.env
            echo "IMAGE_TAG=latest" >> docker/.env
            echo "DB_HOST=${{ secrets.DB_HOST }}" >> docker/.env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> docker/.env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> docker/.env
            echo "DB_PORT=${{ secrets.DB_PORT }}" >> docker/.env
            echo "DB_NAME=${{ secrets.DB_NAME }}" >> docker/.env
            echo "REDIS_HOST=${{ secrets.REDIS_HOST }}" >> docker/.env
            echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> docker/.env
            echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> docker/.env
            echo "REDIS_TIMEOUT=${{ secrets.REDIS_TIMEOUT }}" >> docker/.env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> docker/.env
            echo "DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> docker/.env
  
            # Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
            echo "ðŸ”‘ Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸ ì¤‘..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
  
            # ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            echo "ðŸ“¦ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
  
            # ë°°í¬ ì‹¤í–‰
            cd docker
            if docker ps -q -f name=duit-mysql-prod 2>/dev/null | grep -q .; then
                echo "ðŸŽ¯ ê¸°ì¡´ ì¸í”„ë¼ ê°ì§€ - ì•±ë§Œ ìž¬ì‹œìž‘"
                $COMPOSE_CMD pull app
                $COMPOSE_CMD up -d --no-deps app
            else
                echo "ðŸ”„ ì´ˆê¸° ë°°í¬ - ì „ì²´ ìŠ¤íƒ ì‹œìž‘"  
                $COMPOSE_CMD --profile full up -d
            fi
            cd ..

      - name: Health check and verification
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            cd /home/vagom/duit-server
            
            # Compose ëª…ë ¹ì–´ í™•ì¸
            if docker compose version >/dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
            else
              COMPOSE_CMD="docker-compose"
            fi
            
            echo "ðŸ¥ í—¬ìŠ¤ì²´í¬ ì‹œìž‘..."
            cd docker
            
            # í—¬ìŠ¤ì²´í¬ (3ë¶„ ëŒ€ê¸°)
            for i in {1..60}; do
              if curl -f -s http://localhost:8080/actuator/health >/dev/null 2>&1; then
                echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ êµ¬ë™ë˜ì—ˆìŠµë‹ˆë‹¤! (${i}ë²ˆì§¸ ì‹œë„)"
                break
              fi
              
              if [ $i -eq 60 ]; then
                echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (60íšŒ ì‹œë„ í›„ íƒ€ìž„ì•„ì›ƒ)"
                echo "ðŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸:"
                APP_CONTAINER=$($COMPOSE_CMD ps -q app)
                if [ -n "$APP_CONTAINER" ]; then
                  docker logs --tail 50 $APP_CONTAINER || true
                else
                  echo "ì•± ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
                  $COMPOSE_CMD ps
                fi
                exit 1
              else
                echo "â³ ëŒ€ê¸° ì¤‘... (${i}/60)"
                sleep 3
              fi
            done
            
            cd ..
            
            # ë°°í¬ ìƒíƒœ í™•ì¸
            echo ""
            echo "ðŸ“Š ìµœì¢… ë°°í¬ ìƒíƒœ:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep duit
            
            # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
            echo ""
            echo "ðŸ§¹ ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker image prune -f
            
            echo ""
            echo "ðŸŽ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

      - name: Create deployment summary
        run: |
          echo "### ðŸš€ ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë°°í¬ëœ ì´ë¯¸ì§€:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "**PR ë²ˆí˜¸:** #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY 
          echo "**ì»¤ë°‹ SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**ë°°í¬ ì‹œê°„:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
