name: CD - Deploy

on:
  pull_request:
    branches: [main]
    types: [closed]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create build configuration
        run: |
          # Docker ë¹Œë“œìš© ì„¤ì • íŒŒì¼ ìƒì„±
          cat > src/main/resources/application.properties << EOF
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_VALIDITY=${{ secrets.JWT_VALIDITY }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          REDIS_TIMEOUT=${{ secrets.REDIS_TIMEOUT }}
          DISCORD_ALARM_WEBHOOK_URL=${{ secrets.DISCORD_ALARM_WEBHOOK_URL }}
          DISCORD_ERROR_WEBHOOK_URL=${{ secrets.DISCORD_ERROR_WEBHOOK_URL }}
          UPLOAD_DIR=${{ secrets.UPLOAD_DIR }}
          BASE_URL=${{ secrets.BASE_URL }}
          FIREBASE_WEB_API_KEY=${{ secrets.FIREBASE_WEB_API_KEY }}
          EOF

          cat > src/main/resources/firebase-key.json << EOF
          ${{ secrets.FIREBASE_KEY }}
          EOF

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."
            cd /home/vagom/duit-server
  
            # Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            
            # í˜„ì¬ í™œì„± í™˜ê²½ ê°ì§€
            CURRENT_ENV="blue"  # ê¸°ë³¸ê°’
            
            # Blue í™˜ê²½ ì²´í¬
            if docker ps --format "{{.Names}}" | grep -q "duit-server-blue"; then
              if curl -f -s http://localhost:8083/actuator/health >/dev/null 2>&1; then
                CURRENT_ENV="blue"
              fi
            fi
            
            # Green í™˜ê²½ ì²´í¬  
            if docker ps --format "{{.Names}}" | grep -q "duit-server-green"; then
              if curl -f -s http://localhost:8082/actuator/health >/dev/null 2>&1; then
                CURRENT_ENV="green"
              fi
            fi
            
            # íƒ€ê²Ÿ í™˜ê²½ ê²°ì •
            if [ "$CURRENT_ENV" = "blue" ]; then
              TARGET_ENV="green"
              TARGET_PORT="8082"
            else
              TARGET_ENV="blue"
              TARGET_PORT="8083"
            fi
            
            
            # í™˜ê²½ë³„ ë²„ì „ ì„¤ì •
            if [ "$TARGET_ENV" = "blue" ]; then
              export BLUE_VERSION="latest"
              export GREEN_VERSION="${GREEN_VERSION:-latest}"
            else
              export GREEN_VERSION="latest"  
              export BLUE_VERSION="${BLUE_VERSION:-latest}"
            fi
            
            docker compose --profile $TARGET_ENV up -d 
            
            HEALTH_SUCCESS=false
            for i in {1..60}; do
              # ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
              if ! docker ps --format "{{.Names}}" | grep -q "duit-server-$TARGET_ENV"; then
                echo "::error::Container duit-server-$TARGET_ENV is not running"
                break
              fi
              
              # í—¬ìŠ¤ì²´í¬ ì‹¤í–‰
              if docker exec duit-server-$TARGET_ENV curl -f -s http://localhost:8080/actuator/health >/dev/null 2>&1; then
                echo "::notice title=Success::âœ… $TARGET_ENV environment is healthy! (attempt $i)"
                HEALTH_SUCCESS=true
                break
              fi
              
              if [ $i -eq 60 ]; then
                echo "::error title=Health Check Failed::âŒ Health check timeout after 60 attempts (3 minutes)"
                echo "::group::ğŸ“‹ Container Logs"
                docker logs --tail 50 duit-server-$TARGET_ENV || true
                echo "::endgroup::"
                break
              else
                echo "::notice::Health check attempt $i/60 - waiting 3s..."
                sleep 3
              fi
            done
            echo "::endgroup::"
            
            # í—¬ìŠ¤ì²´í¬ ê²°ê³¼ì— ë”°ë¥¸ ì²˜ë¦¬
            if [ "$HEALTH_SUCCESS" = true ]; then
              # íŠ¸ë˜í”½ ì „í™˜
              echo "::group::ğŸ”„ Traffic Switching"
              echo "::notice::Switching traffic to $TARGET_ENV environment..."
              
              if [ -f "switch-traffic.sh" ]; then
                ./switch-traffic.sh $TARGET_ENV
                echo "::notice title=Success::âœ… Traffic switched to $TARGET_ENV"
                
                # ì´ì „ í™˜ê²½ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
                echo "::notice::Stopping previous environment: $CURRENT_ENV"
                docker compose --profile $CURRENT_ENV down
                echo "::notice title=Success::âœ… Previous environment ($CURRENT_ENV) stopped"
                
              else
                echo "::warning::Traffic switching script not found. Manual configuration required."
                docker compose --profile $TARGET_ENV down 
              fi
              echo "::endgroup::"
              
            else
              # ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
              echo "::group::ğŸ”„ Rollback Process"  
              echo "::error::Health check failed. Rolling back $TARGET_ENV environment..."
              docker-compose --profile $TARGET_ENV stop app-$TARGET_ENV || true
              docker-compose --profile $TARGET_ENV rm -f app-$TARGET_ENV || true
              echo "::notice::Rollback completed. $CURRENT_ENV environment remains active."
              echo "::endgroup::"
              echo "::endgroup::"  # Close main deployment group
              exit 1
            fi
            echo "::endgroup::"

      - name: Post-deployment verification
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            echo "::group::ğŸ” Deployment Verification"
            cd /home/vagom/duit-server
            
            # ìµœì¢… í—¬ìŠ¤ì²´í¬ (ì™¸ë¶€ì—ì„œ ì ‘ê·¼)
            echo "::notice::Final health check via external endpoint..."
            sleep 10  # íŠ¸ë˜í”½ ì „í™˜ í›„ ì•ˆì •í™” ëŒ€ê¸°
            
            if curl -f -s ${{ secrets.BASE_URL }}/actuator/health >/dev/null 2>&1; then
              echo "::notice title=Success::âœ… External health check passed"
            else
              echo "::warning::External health check failed, but deployment may still be successful"
            fi
            
            # ë°°í¬ ìƒíƒœ í™•ì¸
            echo "::group::ğŸ“Š Deployment Status"
            echo "::notice::Container status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep duit || echo "No duit containers found"
            
            # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
            echo "::notice::Cleaning up old images..."
            docker image prune -f
            
            echo "::notice title=Success::ğŸ‰ Blue-Green deployment completed successfully!"
            echo "::endgroup::"

      - name: Create deployment summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "### ğŸ‰ Blue-Green ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
            echo "**ë°°í¬ ì‹œê°„:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            echo "**ì´ë¯¸ì§€:** ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
            echo "**í—¬ìŠ¤ì²´í¬:** /actuator/health" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… ë¬´ì¤‘ë‹¨ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
            echo "**ì‹¤íŒ¨ ì‹œê°„:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            echo "**ì˜¤ë¥˜:** ë°°í¬ ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ê¸°ì¡´ í™˜ê²½ì´ ìœ ì§€ë˜ê³  ìˆìœ¼ë‹ˆ ì„œë¹„ìŠ¤ì—ëŠ” ì˜í–¥ì´ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always() # ë¹Œë“œ ì‹¤íŒ¨ ì‹œì—ë„ ë³´ë‚´ê¸° ìœ„í•´ ì„¤ì •
        with:
          webhook: ${{ secrets.DISCORD_DEPLOY_WEBHOOK }}